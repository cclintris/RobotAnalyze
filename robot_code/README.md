# 分析机器人源代码

## B 部分实验报告 - 分析机器人源代码

### 撞库机器人

- 分析思路：产生大量登录请求，同一 IP 可能尝试了多个帐号；登录完成后行为很少；可能会经常给出错误的 authCode 或者 password，导致 sessionId 经常更换
- 分析过程：
  - 筛选出尝试登录过两个以上账号的 ip 地址
    - 每个 ip 登录账号数量的中位数为 1，为了区分忘记密码的用户和撞库机器人，我们认为撞库机器人至少会尝试登录两个以上的账号
  - 在上一步的基础上，统计每个 ip 地址登录某一账号成功、失败的次数，并计算对应的失败率
  - 在上一步的基础上，筛选出失败率大于等于 0.5 账号及其对应的 ip 地址
    - 最初我们选择 0.8 作为阈值，因为在测试数据中没有出现正常用户失败率超过 0.5 的情况；但在实际筛选时，我们发现撞库机器人在第一次登录成功后，后续登录
      便不再出现反复登陆失败的问题，导致真实错误率低于我们的预期；所以结合生活实际，我们决定取 0.5 作为最终阈值
  - 在上一步基础上，检测每个账号登录后的行为数量；行为数低于 3 的账号视为低活跃度账号，如果每个 ip 登录的账号中低活跃度账号占比超过 90%，则认为该 ip 为撞库机器人
    - 每个账号登陆后的行为中位数为 3，且没有行为数为 0 的账号，因此我们认为行为少于 3 的账号为低活跃度
- 分析结果：见撞库机器人.txt，比例不超过 1%

### 爬虫机器人

- 分析思路：同一 IP 地址对应数个用户，大量顺序重复单一或数个类目下的浏览行为；大量短时间内重复浏览请求
- 分析过程：
  - 筛选出尝试登录过两个及以上账号的 ip 地址
    - 这个判断条件与撞库机器人的第一重判断条件有重合，考虑到撞库机器人几乎都符合“尝试登录过两个以上账号”这个条件，这里放宽限制
  - 在上一步的基础上，找到每个用户 id 的行为对应的时间和商品种类
  - 在上一步基础上，设置计数器 count，若用户 id 连续查看同一品类商品且两次查看时间小于 300s，则 count 加一，否则 count 归零继续寻找，直到 count>=4 判断其为机器人或完全找完判定其不是机器人
- 分析结果：见刷单机器人.txt，比例不超过 1%

### 刷单机器人

- 分析思路：对应的购买行为集中在同一商品上，大量短时间内重复购买请求
- 分析过程：
  - 查找出每个用户在每件商品上购买的次数
  - 在上一步的基础上，找到那些在同一商品上购买超过 5 次的用户 id
    - 这个标准已经够宽松，我们统计到的中位数为 1。但是标准设的太低的话，刷单太少刷单机器人没意义，最后在多次尝试下最终选择 5
  - 在上一步的基础上，找到用户 id 对应的商品 id 以及时间属性
  - 在上一步基础上，设置计数器 count，若用户 id 购买同一商品且两次购买时间小于 300s，则 count 加一，否则 count 归零继续寻找，直到 count>=4 判断其为机器人或完全找完判定其不是机器人
- 分析结果：见刷单机器人.txt，比例不超过 1%

### 抢单机器人

#### 抢单机器人特征：

1. 抢购成功率较高

2. 在短时间内，连续快速发起多次购买请求

3. 在一次抢购失败后，仍然发起了多次购买请求

- ”在整点整附近进行抢购“ **不是**特征，分析数据可以看到几乎所有的抢购事件都发生在整点附近

#### 分析方法：

从数据库中选出所有购买类型为秒杀的记录

- 根据特征 1：计算出每个用户的抢单成功率。

  - <img src="https://i.loli.net/2021/06/05/wGSWhqFmL5Tndp9.png" alt="image-20210605170216225.png" style="zoom:50%;" />

    可以看到大多数用户的成功率都小于 0.3（大多数都为 0）

- 根据特征 2 计算每个用户在内连续>=5 次在 5s 内发起过购买请求的商品数量

  - <img src="https://i.loli.net/2021/06/05/xK2usZD6opQFLJG.png" alt="image-20210605170657596.png" style="zoom:50%;" />

    可以看到大多数用户的数量都小于 3（大多数都为 0）

- 根据特征 3 计算每个用户在一次抢购失败后，仍然发起了购买请求的次数

  - <img src="https://i.loli.net/2021/06/05/jq4YTa7Qner9ESz.png" alt="image-20210605170827048.png" style="zoom:50%;" />

    可以看到大多数用户的数量都小于 5（大多数都为 0）

根据上述分析，将每个用户的成功率+商品数量 _ 0.1+失败后请求数量 _ 0.1 作为用户的评分。当评分大于 1 时，可以判断为抢单机器人。（此算法与阈值都较为宽松，可以视情况调整为更为严格的判断标准）

#### 结果

根据以上的算法，可以看到 user_id = “1014980”被判断为抢单机器人。检查其行为

<img src="https://i.loli.net/2021/06/05/51CjgyDQ6iBHaG7.png" alt="image-20210605155602695.png" style="zoom:50%;" />

```python
# 数据格式
dic = {
    "用户id": {
        "商品id": [("购买时间", "是否成功"), ...]
    }
}
```

几乎可以断言此用户为抢单机器人。
